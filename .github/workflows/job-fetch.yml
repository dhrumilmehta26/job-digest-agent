# Job Aggregator - Daily Job Fetch Workflow
# 
# This workflow fetches jobs from multiple sources, stores them in MongoDB,
# and sends email notifications via SMTP (Gmail by default).
#
# Schedule: Runs daily at 7:30 AM in your configured timezone
# Manual: Can be triggered manually via workflow_dispatch
#
# Required Secrets (add in GitHub Repository Settings > Secrets and variables > Actions):
# - MONGODB_URI: MongoDB connection string
# - SMTP_USER: SMTP username (Gmail address)
# - SMTP_PASSWORD: SMTP password (Gmail App Password)
# - FROM_EMAIL: Sender email address (often same as SMTP_USER)
# - TO_EMAILS: Comma-separated recipient emails
# - SEARCH_KEYWORDS: Comma-separated search keywords
# - USER_TIMEZONE: Your timezone (e.g., America/New_York)
# - PREFERRED_LOCATIONS: Comma-separated locations (e.g., Remote,USA)
#
# Optional Secrets:
# - FROM_NAME: Sender name (defaults to "Job Aggregator")
# - SMTP_HOST: SMTP host (default smtp.gmail.com)
# - SMTP_PORT: SMTP port (default 587)
# - SMTP_USE_TLS: Enable STARTTLS (default true)
# - FILTER_DESIGNATIONS: Job titles to filter
# - FILTER_FIELDS: Job categories to filter
# - MONGODB_DATABASE: Database name (defaults to "job_aggregator")

name: Daily Job Fetch

on:
  # Schedule: Adjust the cron expression based on your timezone
  # Default is 12:30 UTC which is 7:30 AM EST
  # Use https://crontab.guru to adjust for your timezone
  schedule:
    - cron: '30 12 * * *'  # 12:30 UTC = 7:30 AM EST / 6:30 AM CST / 5:30 AM PST
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no email)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  fetch-jobs:
    name: Fetch & Notify Jobs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Job Aggregator
        env:
          # Required secrets
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          SMTP_HOST: ${{ secrets.SMTP_HOST || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS || 'true' }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAILS: ${{ secrets.TO_EMAILS }}
          SEARCH_KEYWORDS: ${{ secrets.SEARCH_KEYWORDS }}
          USER_TIMEZONE: ${{ secrets.USER_TIMEZONE }}
          PREFERRED_LOCATIONS: ${{ secrets.PREFERRED_LOCATIONS }}
          
          # Optional secrets with defaults
          FROM_NAME: ${{ secrets.FROM_NAME || 'Job Aggregator' }}
          MONGODB_DATABASE: ${{ secrets.MONGODB_DATABASE || 'job_aggregator' }}
          FILTER_DESIGNATIONS: ${{ secrets.FILTER_DESIGNATIONS || '' }}
          FILTER_FIELDS: ${{ secrets.FILTER_FIELDS || '' }}
          
          # GitHub Actions indicator
          GITHUB_ACTIONS: 'true'
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            echo "Running in TEST mode..."
            python run.py --test
          else
            echo "Running full aggregation pipeline..."
            python run.py
          fi

      - name: Upload job data artifact
        uses: actions/upload-artifact@v4
        with:
          name: jobs-data-${{ github.run_number }}
          path: ui/jobs_data.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## Job Aggregator Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            echo "- **Mode**: Test (no email sent)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mode**: Production" >> $GITHUB_STEP_SUMMARY
          fi


